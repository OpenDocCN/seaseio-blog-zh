<html>
<head>
<title>Apache Solr Distributed Facets</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1 class="translated">Apache Solr分布式方面</h1>
<blockquote>原文：<a href="https://web.archive.org/web/sease.io/2018/10/apache-solr-distributed-facets.html#0001-01-01">https://web.archive.org/web/sease.io/2018/10/apache-solr-distributed-facets.html#0001-01-01</a></blockquote>
									<section class="elementor-section elementor-top-section elementor-element elementor-element-6d4f9b9d ot-traditional elementor-section-boxed elementor-section-height-default elementor-section-height-default" data-id="6d4f9b9d" data-element_type="section">
						<div class="elementor-container elementor-column-gap-default">
							<div class="elementor-row">
					<div class="elementor-column elementor-col-100 elementor-top-column elementor-element elementor-element-23fc33a9 ot-flex-column-vertical" data-id="23fc33a9" data-element_type="column">
			<div class="elementor-column-wrap elementor-element-populated">
							<div class="elementor-widget-wrap">
						<div class="elementor-element elementor-element-2ac9558f elementor-widget elementor-widget-text-editor" data-id="2ac9558f" data-element_type="widget" data-widget_type="text-editor.default">
				<div class="elementor-widget-container">
								<div class="elementor-text-editor elementor-clearfix">
				Apache Solr distributed faceting feature has been introduced back in 2008 with the first versions of Solr (1.3 according to this jira[1]) .
Until now, I always assumed it just worked, without diving too much into the details.
Nowadays distributed search and faceting are extremely popular, you can find them pretty much everywhere (in the legacy or SolrCloud form alike).
<strong>N.B.</strong> Although the mechanics are pretty much the same, Json faceting revisits this approach with some change, so we will now focus on <strong>legacy field faceting</strong>.

I think it’s time to get a better understanding of how it works:
<h2 class="translated">多个分片请求</h2>
When dealing with distributed search and distributed aggregation calculations, you are going to see multiple requests going back and forth across the shards.
They have different focus and are meant to retrieve the different bits of information necessary to build the final response.
We are going to explore the different rounds of requests, focusing just for the faceting purpose.
<strong>N.B.</strong> Some of these requests are also carrying results for the distributed search calculation, this is used to minimise the network traffic.

For the sake of this blog let’s simulate a simple sharded index, white space tokenization on field1 and facet.field=<strong>field1</strong>
<table class="tg" style="height: 103px;" width="804">
<tbody>
<tr>
<th class="tg-s8ba translated">碎片1</th>
<th class="tg-s8ba translated">碎片2</th>
</tr>
<tr>
<td class="tg-vc88 translated"><em> Doc0 </em> <em> { "id":"1 "，</em><em>" field 1 ":" a b "</em><em>}</em></td>
<td class="tg-vc88 translated"><em> Doc3 </em> <em> { "id":"4 "，</em><em>" field 1 ":" b c "</em><em>}</em></td>
</tr>
<tr>
<td class="tg-vc88 translated"><em> Doc1 </em> <em> { "id":"2 "，</em><em>" field 1 ":" a "</em><em>}</em></td>
<td class="tg-vc88 translated"><em> Doc4 </em> <em> { "id":"5 "，</em><em>" field 1 ":" b c "</em><em>}</em></td>
</tr>
<tr>
<td class="tg-vc88 translated"><em> Doc2 </em> <em> { "id":"3 "，</em><em>" field 1 ":" b c "</em><em>}</em></td>
<td class="tg-vc88 translated"><em> Doc53 </em> <em> { "id":"6 "，</em><em>" field 1 ":" c "</em><em>}</em></td>
</tr>
</tbody>
</table>
<strong>Global Facets</strong> : b(4), c(4), a(2)

<strong>Shard 1 Local Facets</strong> : a(2), b(2), c(1)

<strong>Shard 2 Local Facets</strong> : c(3), b(2)
<h2 class="translated">候选方面字段值的集合</h2>
The first round of requests is sent to each shard to identify the candidate top K global facet values.
To achieve this target each shard will be requested to respond with its local top K+J facet values and counts.
The reason we actually ask for more facets from each shard is to have a better term coverage, to avoid losing relevant facet values and to minimise the refinement requests.
How many more we request from each shard is regulated by the “overrequest” facet parameter, a factor that gives more accurate facets at the cost of additional computations[2].
Let’s assume we configure a <strong><em>facet.limit=2&amp;facet.overrequest.count=0&amp;facet.overrequest.ratio=1 </em></strong>to explain when refinement happens and how it works.

<strong>Shard 1 Returned Facets</strong> : a(2), b(2)

<strong>Shard 2 Returned Facets</strong> : c(3), b(2)
<h2 class="translated">收集的计数的全局合并</h2>
The facet value counts collected from each shard are merged and the most occurring global top K is calculated.
These facet field values are the first candidates to be the final ones.
In addition to that, other candidates are extracted from the terms below the top K, based on the shards that didn’t return those values statistics.
At this point we have a candidate set of values and we are ready to refine their counts where necessary, asking back this information to the shards that didn’t include that in the first round.
This happens including the following specific facet parameter to the following refinement requests:

{!terms=$&lt;field&gt;__terms}&lt;field&gt;&amp;&lt;field&gt;__terms=&lt;values&gt;
e.g.
{!terms=$field1__terms}field1&amp;field1__terms=term1,term2

<strong>N.B.</strong> This request is specifically asking a Solr instance to return back the facet counts just for the terms specified[3]

<strong>Top 2 candidates</strong> = b(4), c(3)
<strong>Additional candidates</strong> = a(2)

The reason that <strong>a(2)</strong> is added to the potential candidates is because Shard 2 didn’t answer with a count for <strong>a, </strong>the potential missing count of 1 could bring <strong>a</strong> to the top K. So it is worth a verification.

Shard 1 didn’t return any value for the candidate <strong>c</strong> facet.
So the following request is built and sent to it:
<em>facet.field={!terms=$field1__terms}field1&amp;field1__terms=c</em>

Shard 2 didn’t return any value for the candidate <strong>a</strong> facet.
So the following request is built and sent to it:
<em>facet.field={!terms=$field1__terms}field1&amp;field1__terms=a</em>
<h2 class="translated">最终计数细化</h2>
The refinements counts returned by each shard can be used to finalise the global candidate facet values counts and to identify the final top K to be returned by the distributed request.
We are finally done!

<strong>Shard 1 Refinements Facets</strong> : c(1)

<strong>Shard 2 Refinements Facets</strong> : a(0)

<strong>Top K candidates updated</strong> :  <strong>b(4), c(4)</strong>, a(2)

GIven a facet.limit=2 the final global facets with correct results returned is :
<strong>b(4), c(4)</strong>

 

[1] <a href="https://web.archive.org/web/20220930001324/https://issues.apache.org/jira/browse/SOLR-303">https://issues.apache.org/jira/browse/SOLR-303</a>

[2] <a href="https://web.archive.org/web/20220930001324/https://lucene.apache.org/solr/guide/6_6/faceting.html#Faceting-Over-RequestParameters">https://lucene.apache.org/solr/guide/6_6/faceting.html#Faceting-Over-RequestParameters</a>

[3] <a href="https://web.archive.org/web/20220930001324/https://lucene.apache.org/solr/guide/7_5/faceting.html#limiting-facet-with-certain-terms">https://lucene.apache.org/solr/guide/7_5/faceting.html#limiting-facet-with-certain-terms</a>					</div>
						</div>
				</div>
						</div>
					</div>
		</div>
								</div>
					</div>
		</section>
				<section class="elementor-section elementor-top-section elementor-element elementor-element-18fca62 ot-traditional elementor-section-boxed elementor-section-height-default elementor-section-height-default" data-id="18fca62" data-element_type="section" data-settings="{&quot;background_background&quot;:&quot;classic&quot;}">
						<div class="elementor-container elementor-column-gap-default">
							<div class="elementor-row">
					<div class="elementor-column elementor-col-100 elementor-top-column elementor-element elementor-element-3541a56c ot-flex-column-vertical" data-id="3541a56c" data-element_type="column">
			<div class="elementor-column-wrap elementor-element-populated">
							<div class="elementor-widget-wrap">
						<div class="elementor-element elementor-element-64781b35 elementor-widget elementor-widget-iheading" data-id="64781b35" data-element_type="widget" data-widget_type="iheading.default">
				<div class="elementor-widget-container">
					<div class="ot-heading">
	        	            <span>// our service</span>
	        <h2 class="main-heading translated">不要脸的塞给我们培训和服务！</h2>	    </div>
	    		</div>
				</div>
				<div class="elementor-element elementor-element-2c1eeb08 elementor-widget elementor-widget-text-editor" data-id="2c1eeb08" data-element_type="widget" data-widget_type="text-editor.default">
				<div class="elementor-widget-container">
								<div class="elementor-text-editor elementor-clearfix">
				<p class="translated">我提到过我们做<a href="https://web.archive.org/web/20220930001324/https://sease.io/training/apache-solr-training/apache-solr-beginner-training"> Apache Solr初学者</a>和<a href="https://web.archive.org/web/20220930001324/https://sease.io/training/elasticsearch-trainings/elasticsearch-beginner-training"> Elasticsearch初学者</a>培训吗？<br/>我们也提供这些主题的咨询，<a href="https://web.archive.org/web/20220930001324/https://sease.io/contacts">如果你想让你的搜索引擎更上一层楼，请联系</a>！</p>					</div>
						</div>
				</div>
						</div>
					</div>
		</div>
								</div>
					</div>
		</section>
				<section class="elementor-section elementor-top-section elementor-element elementor-element-88c293f ot-traditional elementor-section-boxed elementor-section-height-default elementor-section-height-default" data-id="88c293f" data-element_type="section">
						<div class="elementor-container elementor-column-gap-default">
							<div class="elementor-row">
					<div class="elementor-column elementor-col-100 elementor-top-column elementor-element elementor-element-172db6a0 ot-flex-column-vertical" data-id="172db6a0" data-element_type="column">
			<div class="elementor-column-wrap elementor-element-populated">
							<div class="elementor-widget-wrap">
						<div class="elementor-element elementor-element-506301ef elementor-widget elementor-widget-iheading" data-id="506301ef" data-element_type="widget" data-widget_type="iheading.default">
				<div class="elementor-widget-container">
					<div class="ot-heading">
	        	            <span>// STAY ALWAYS UP TO DATE</span>
	        <h2 class="main-heading translated">订阅我们的时事通讯</h2>	    </div>
	    		</div>
				</div>
				<div class="elementor-element elementor-element-23425778 elementor-widget elementor-widget-text-editor" data-id="23425778" data-element_type="widget" data-widget_type="text-editor.default">
				<div class="elementor-widget-container">
								<div class="elementor-text-editor elementor-clearfix">
				<p class="translated">你喜欢这篇关于Apache Solr分布式方面的文章吗？不要忘记订阅我们的时事通讯，以便随时了解信息检索世界的最新动态！</p>					</div>
						</div>
				</div>
				<div class="elementor-element elementor-element-696a43fb elementor-widget elementor-widget-wp-widget-mc4wp_form_widget" data-id="696a43fb" data-element_type="widget" data-widget_type="wp-widget-mc4wp_form_widget.default">
				<div class="elementor-widget-container">
			<script>(function() {
	window.mc4wp = window.mc4wp || {
		listeners: [],
		forms: {
			on: function(evt, cb) {
				window.mc4wp.listeners.push(
					{
						event   : evt,
						callback: cb
					}
				);
			}
		}
	}
})();
</script><!-- Mailchimp for WordPress v4.8.8 - https://wordpress.org/plugins/mailchimp-for-wp/ --><form id="mc4wp-form-1" class="mc4wp-form mc4wp-form-1343" method="post" data-id="1343" data-name="Sease Mailchimp"><div class="mc4wp-form-fields">
<div class="subscribe-inner-form">
	<input type="email" name="EMAIL" placeholder="Your Email" required=""/>
	<button type="submit" class="subscribe-btn-icon"><i class="flaticon-telegram"/></button>
</div>	

<p class="translated"><label> <input name="AGREE_TO_TERMS" type="checkbox" value="1" required=""/> <a href="https://web.archive.org/web/20220930001324/https://sease.io/privacy-policy" target="_blank">我已经阅读并同意隐私政策</a> </label></p></div><label style="display: none !important;">Leave this field empty if you're human: <input type="text" name="_mc4wp_honeypot" value="" tabindex="-1" autocomplete="off"/></label><input type="hidden" name="_mc4wp_timestamp" value="1664496804"/><input type="hidden" name="_mc4wp_form_id" value="1343"/><input type="hidden" name="_mc4wp_form_element_id" value="mc4wp-form-1"/><div class="mc4wp-response"/></form><!-- / Mailchimp for WordPress Plugin -->		</div>
				</div>
						</div>
					</div>
		</div>
								</div>
					</div>
		</section>
									    
</body>
</html>